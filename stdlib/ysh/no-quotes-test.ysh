#!bin/ysh

shopt -s redefine_proc_func  # log
shopt -s parse_sh_arith  # ${BASH_SOURCE[0]}

source ///ysh/no-quotes.ysh  # module under test

: ${LIB_OSH=stdlib/osh}
source $LIB_OSH/two.sh  
source $LIB_OSH/task-five.sh

proc _check (; val) {  # TODO: assert
  if (not val) {
    pp line (val)
    error "Failed:"
  }
}

_demo-stderr() {
  echo zzz "$@" >& 2
  return 99
}

proc test-nq-capture {

  nq-capture (&r) {
    write --end '' hi
  }
  _check (0 === r.status)
  _check ('hi' === r.stdout)

  #return

  nq-capture (&r) {
    echo hi
  }
  #pp line (r)
  _check (0 === r.status)
  _check (u'hi\n' === r.stdout)

  # TODO: _demo-stderr fails - we catch this earlier though!
  nq-capture-2 (&r) {
    _demo-stderr yyy
  }
  _check (99 === r.status)
  _check (u'zzz yyy\n' === r.stderr)

  nq-capture (&r) {
    _demo-stderr aaa
  }
  _check (99 === r.status)
  _check ('' === r.stdout)
}

proc test-nq-redir {
  local status stdout_file

  nq-redir status stdout_file \
    seq 3
  nq-assert 0 = "$status"
  diff -u $stdout_file - << EOF
1
2
3
EOF

  local stderr_file
  nq-redir-2 status stderr_file \
    log $'hi\nthere'
  nq-assert 0 = "$status"

  # TODO: nq-diff - this can diff files and show LINE number of error

  set +o errexit
  diff -u $stderr_file - << EOF
hi
there
EOF
}

task-five "$@"
